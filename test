Fluent, SaveManager, InterfaceManager = loadstring(Game:HttpGet("https://raw.githubusercontent.com/FyyZED/FyyX/refs/heads/main/Liblarry.lua"))()
local Window = Fluent:CreateWindow({
    Title = "Fyy X Fish IT | FREE",
    SubTitle = "by Fyy Community",
    TabWidth = 150,
    Size = UDim2.fromOffset(530, 300),
    Acrylic = true,
    Theme = "Arctic",
    MinimizeKey = Enum.KeyCode.G,
    BackgroundImage = "rbxassetid://78893380921225",
    BackgroundTransparency = 0.4
})

local Options = Fluent.Options
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-- Setup SaveManager & InterfaceManager
SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)
SaveManager:IgnoreThemeSettings()
SaveManager:SetIgnoreIndexes({})
InterfaceManager:SetFolder("FyyScriptHub")
SaveManager:SetFolder("FyyScriptHub/FishIT")

-- Create all tabs directly
local Info = Window:AddTab({Title = "Info", Icon = "info"})
local Premium = Window:AddTab({Title = "Kaitun VIP", Icon = "crown"})
local PlayerTab = Window:AddTab({Title = "Player", Icon = "user"})
local Auto = Window:AddTab({Title = "Main", Icon = "play"})
local Shop = Window:AddTab({Title = "Shop", Icon = "shopping-cart"})
local Teleport = Window:AddTab({Title = "Teleport", Icon = "map-pin"})
local Totem = Window:AddTab({Title = "Totem", Icon = "hexagon"})
local Quest = Window:AddTab({Title = "Quest", Icon = "loader"})
local Event = Window:AddTab({Title = "Event", Icon = "gift"})
local Trade = Window:AddTab({Title = "Trade", Icon = "repeat"})
local Enchant = Window:AddTab({Title = "Enchants", Icon = "star"})
local Animation = Window:AddTab({Title = "Animation", Icon = "gem"})
local Discord = Window:AddTab({Title = "Webhook", Icon = "megaphone"})
local SettingTab = Window:AddTab({Title = "Settings", Icon = "settings"})
local MiscTab = Window:AddTab({Title = "Misc", Icon = "globe"})
local ConfigTab = Window:AddTab({Title = "Config", Icon = "folder"})

InterfaceManager:BuildInterfaceSection(ConfigTab)
SaveManager:BuildConfigSection(ConfigTab)

-- Info Tab
Info:AddParagraph({
    Title = "Welcome!",
    Content = "Script loaded successfully.\nEnjoy using Fyy X Fish IT!"
})

Info:AddParagraph({
    Title = "IMPORTANT!",
    Content = "Have Problem / Need Help? Join Server Now."
})

Info:AddButton({
    Title = "Copy Discord Link",
    Description = "Click to copy Discord invite link",
    Callback = function()
        local success = pcall(function()
            setclipboard("https://discord.gg/77nEeYeFRp")
        end)
        if success then
            Fluent:Notify({
                Title = "Success",
                Content = "Discord link copied to clipboard!\nhttps://discord.gg/77nEeYeFRp",
                Duration = 5
            })
        else
            Fluent:Notify({
                Title = "Error",
                Content = "Failed to copy link to clipboard",
                Duration = 3
            })
        end
    end
})

local P = PlayerTab:AddSection(" [ Player Feature ] ")

local ws = 16
local wst = P:AddToggle("WalkSpeedToggle", {
    Title = "WalkSpeed",
    Default = false
})

local wsi = P:AddInput("WalkSpeedInput", {
    Title = "Set WalkSpeed",
    Default = "16",
    Placeholder = "Enter number (e.g. 50)",
    Numeric = true,
    Finished = false,
    Callback = function(v)
        ws = tonumber(v) or 16
        if Options.WalkSpeedToggle.Value then 
            local c = LocalPlayer.Character 
            if c and c:FindFirstChild("Humanoid") then 
                c.Humanoid.WalkSpeed = ws 
            end 
        end
    end
})

wst:OnChanged(function(e)
    local c = LocalPlayer.Character 
    if c and c:FindFirstChild("Humanoid") then 
        c.Humanoid.WalkSpeed = e and ws or 16 
    end 
end)

local IJC
local ijt = P:AddToggle("InfiniteJump", {
    Title = "Infinite Jump",
    Default = false
})

ijt:OnChanged(function(e)
    local UIS = game:GetService("UserInputService")
    if e then 
        IJC = UIS.JumpRequest:Connect(function()
            local c = LocalPlayer.Character 
            if c and c:FindFirstChild("Humanoid") then 
                c.Humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
            end 
        end)
    elseif IJC then 
        IJC:Disconnect()
        IJC = nil 
    end
end)

local NCC
local nct = P:AddToggle("NoClip", {
    Title = "NoClip",
    Default = false
})

nct:OnChanged(function(e)
    if e then 
        NCC = game:GetService("RunService").Stepped:Connect(function()
            local c = LocalPlayer.Character 
            if c then 
                for _, p in ipairs(c:GetChildren()) do 
                    if p:IsA("BasePart") then 
                        p.CanCollide = false 
                    end 
                end 
            end 
        end)
    elseif NCC then 
        NCC:Disconnect()
        NCC = nil 
        local c = LocalPlayer.Character 
        if c then 
            for _, p in ipairs(c:GetChildren()) do 
                if p:IsA("BasePart") then 
                    p.CanCollide = true 
                end 
            end 
        end 
    end
end)

local wow, wp = false, nil
local wwt = P:AddToggle("WalkOnWater", {
    Title = "Walk On Water",
    Default = false
})

wwt:OnChanged(function(e)
    wow = e 
    local c = LocalPlayer.Character
    if e and c then 
        local h = c:FindFirstChild("HumanoidRootPart")
        if h then 
            if wp then 
                wp:Destroy()
            end 
            wp = Instance.new("Part")
            wp.Anchored = true 
            wp.CanCollide = true 
            wp.Size = Vector3.new(20, 1, 20)
            wp.Transparency = 1 
            wp.Position = Vector3.new(h.Position.X, 0, h.Position.Z)
            wp.Parent = workspace 
        end
    elseif wp then 
        wp:Destroy()
        wp = nil 
    end
end)

game:GetService("RunService").Heartbeat:Connect(function()
    if wow and wp then 
        local c = LocalPlayer.Character 
        if c and c:FindFirstChild("HumanoidRootPart") then 
            local p = c.HumanoidRootPart.Position 
            wp.Position = Vector3.new(p.X, 0, p.Z)
        end 
    end 
end)

local RS = game:GetService("ReplicatedStorage")
local net = RS.Packages._Index["sleitnick_net@0.2.0"].net
local RF_E, RF_U = net["RF/EquipOxygenTank"], net["RF/UnequipOxygenTank"]
local ox = false

local iot = P:AddToggle("EquipOxygenTank", {
    Title = "Equip Oxygen Tank",
    Default = false
})

iot:OnChanged(function(e)
    ox = e 
    if ox then 
        RF_E:InvokeServer(105)
    else 
        RF_U:InvokeServer()
    end 
end)

local RF_R = net["RF/UpdateFishingRadar"]
local ert = P:AddToggle("BypassFishingRadar", {
    Title = "Bypass Fishing Radar",
    Default = false
})

ert:OnChanged(function(e)
    RF_R:InvokeServer(e and true or false)
end)

local saveCF = nil
LocalPlayer.CharacterAdded:Connect(function(c)
    if not saveCF then return end 
    local h = c:WaitForChild("HumanoidRootPart", 5)
    if h then 
        task.wait(.3)
        h.CFrame = saveCF 
    end 
end)

P:AddButton({
    Title = "Respawn at Current Position",
    Description = "Respawn at your current location",
    Callback = function()
        local c = LocalPlayer.Character 
        if not c then return end 
        local h = c:FindFirstChild("HumanoidRootPart")
        local hu = c:FindFirstChild("Humanoid")
        if h and hu then 
            saveCF = h.CFrame 
            hu.Health = 0 
        end 
    end
})

local G = PlayerTab:AddSection(" [ Gui External ] ")

G:AddButton({
    Title = "Fly GUI",
    Description = "Load Fly GUI",
    Callback = function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/XNEOFF/FlyGuiV3/main/FlyGuiV3.txt"))()
        Fluent:Notify({
            Title = "Fly",
            Content = "Fly GUI berhasil dijalankan",
            Duration = 3
        })
    end
})

local SG, SL = nil, nil
local sot = G:AddToggle("StatsOverlay", {
    Title = "Show Stats Overlay",
    Description = "Menampilkan FPS, CPU(ms), Ping, Notifications Count (Draggable)",
    Default = false
})

sot:OnChanged(function(e)
    if e then 
        if SG then 
            SG:Destroy()
        end
        
        local g = Instance.new("ScreenGui", game.CoreGui)
        g.Name = "RockHub_Stats"
        g.IgnoreGuiInset = true
        
        local f = Instance.new("Frame", g)
        f.Size = UDim2.fromOffset(360, 40)
        f.AnchorPoint = Vector2.new(.5, 0)
        f.Position = UDim2.new(.5, 0, .06, 0)
        f.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
        f.BackgroundTransparency = .2 
        f.BorderSizePixel = 0 
        f.Active = true 
        f.Selectable = true
        
        Instance.new("UICorner", f).CornerRadius = UDim.new(1, 0)
        
        local s = Instance.new("UIStroke", f)
        s.Color = Color3.fromHex("8B5CF6")
        s.Thickness = 2 
        s.Transparency = .1 
        s.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
        
        local db = Instance.new("Frame")
        db.Name = "DragBar"
        db.Size = UDim2.new(.6, 0, 0, 6)
        db.Position = UDim2.new(.2, 0, 1, 8)
        db.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
        db.BorderSizePixel = 0 
        db.Active = true 
        db.Selectable = true 
        db.Parent = f
        
        local dc = Instance.new("UICorner")
        dc.CornerRadius = UDim.new(1, 0)
        dc.Parent = db
        
        local ds = Instance.new("UIStroke")
        ds.Color = Color3.fromHex("8B5CF6")
        ds.Thickness = 1 
        ds.Parent = db
        
        db.MouseEnter:Connect(function()
            db.BackgroundColor3 = Color3.fromRGB(60, 60, 65)
        end)
        
        db.MouseLeave:Connect(function()
            db.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
        end)
        
        local ct = Instance.new("Frame")
        ct.Name = "StatsContainer"
        ct.Size = UDim2.new(1, 0, 1, 0)
        ct.BackgroundTransparency = 1 
        ct.Parent = f
        
        local l = Instance.new("UIListLayout", ct)
        l.FillDirection = Enum.FillDirection.Horizontal 
        l.Padding = UDim.new(0, 15)
        l.HorizontalAlignment = Enum.HorizontalAlignment.Center 
        l.VerticalAlignment = Enum.VerticalAlignment.Center
        
        local function L()
            local t = Instance.new("TextLabel", ct)
            t.AutomaticSize = Enum.AutomaticSize.X 
            t.Size = UDim2.new(0, 0, 1, 0)
            t.BackgroundTransparency = 1 
            t.Font = Enum.Font.GothamBold 
            t.TextSize = 13
            t.TextColor3 = Color3.fromRGB(255, 255, 255)
            t.Text = "..."
            return t 
        end
        
        local UIS = game:GetService("UserInputService")
        local CAS = game:GetService("ContextActionService")
        local dr, di, dst, stp = false, nil, nil, nil 
        local dan = "StatsDragBlocker"
        
        local function upd(i)
            local d = i.Position - dst 
            f.Position = UDim2.new(stp.X.Scale, stp.X.Offset + d.X, stp.Y.Scale, stp.Y.Offset + d.Y)
        end
        
        local function std(i)
            dr = true 
            dst = i.Position 
            stp = f.Position 
            CAS:BindActionAtPriority(dan, function()
                return Enum.ContextActionResult.Sink 
            end, false, Enum.ContextActionPriority.High.Value + 50, Enum.UserInputType.Touch, Enum.UserInputType.MouseButton1, Enum.UserInputType.MouseMovement)
            i.Changed:Connect(function()
                if i.UserInputState == Enum.UserInputState.End then 
                    dr = false 
                    CAS:UnbindAction(dan)
                end 
            end)
        end
        
        local function cda(o)
            o.InputBegan:Connect(function(i)
                if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then 
                    std(i)
                end 
            end)
            o.InputChanged:Connect(function(i)
                if i.UserInputType == Enum.UserInputType.MouseMovement or i.UserInputType == Enum.UserInputType.Touch then 
                    di = i 
                end 
            end)
        end
        
        cda(f)
        cda(db)
        
        UIS.InputChanged:Connect(function(i)
            if dr and (i.UserInputType == Enum.UserInputType.MouseMovement or i.UserInputType == Enum.UserInputType.Touch) then 
                upd(i)
            end 
        end)
        
        local fps, cpu, ping, notifs = L(), L(), L(), L()
        local RSv = game:GetService("RunService")
        local ST = game:GetService("Stats")
        
        local notifCount = 0
        
        -- Connection untuk monitoring notifikasi secara real-time
        local notifConnection = nil
        
        local function setupNotifMonitoring()
            local player = game:GetService("Players").LocalPlayer
            local function checkNotifs()
                if not player then return 0 end
                
                local playerGui = player:FindFirstChild("PlayerGui")
                if not playerGui then return 0 end
                
                local textNotifications = playerGui:FindFirstChild("Text Notifications")
                if not textNotifications then return 0 end
                
                local count = 0
                for _, child in ipairs(textNotifications:GetChildren()) do
                    if child:IsA("Frame") or child:IsA("GuiObject") then
                        if child.Visible then
                            count = count + 1
                        end
                    end
                end
                return count
            end
            
            -- Cek setiap 0.2 detik untuk update real-time
            if notifConnection then
                notifConnection:Disconnect()
            end
            
            notifConnection = RSv.Heartbeat:Connect(function()
                notifCount = checkNotifs()
            end)
        end
        
        -- Setup monitoring saat GUI pertama kali dibuat
        setupNotifMonitoring()
        
        -- Re-setup jika player berganti character/join ulang
        game:GetService("Players").LocalPlayer.CharacterAdded:Connect(function()
            task.wait(1) -- Tunggu GUI dimuat
            setupNotifMonitoring()
        end)
        
        SL = RSv.RenderStepped:Connect(function(dt)
            if not g then return end
            
            local fpsValue = math.floor(workspace:GetRealPhysicsFPS())
            local cpuValue = math.floor(dt * 1000)
            local pingValue = math.floor(ST.Network.ServerStatsItem["Data Ping"]:GetValue())
            
            fps.Text = "FPS: " .. fpsValue 
            fps.TextColor3 = fpsValue >= 50 and Color3.fromRGB(0, 255, 127) or Color3.fromRGB(255, 65, 65)
            
            cpu.Text = "CPU: " .. cpuValue .. "ms"
            cpu.TextColor3 = cpuValue <= 20 and Color3.fromRGB(0, 255, 127) or (cpuValue <= 50 and Color3.fromRGB(255, 215, 0) or Color3.fromRGB(255, 65, 65))
            
            ping.Text = "Ping: " .. pingValue .. "ms"
            ping.TextColor3 = pingValue < 100 and Color3.fromRGB(0, 255, 127) or Color3.fromRGB(255, 65, 65)
            
            notifs.Text = "Notifs: " .. notifCount
            notifs.TextColor3 = notifCount == 0 and Color3.fromRGB(180, 180, 180) or 
                                notifCount < 3 and Color3.fromRGB(0, 255, 127) or 
                                notifCount < 6 and Color3.fromRGB(255, 215, 0) or 
                                Color3.fromRGB(255, 65, 65)
        end)
        
        SG = g
    else 
        if SL then 
            SL:Disconnect()
            SL = nil 
        end 
        
        if notifConnection then
            notifConnection:Disconnect()
            notifConnection = nil
        end
        
        if SG then 
            SG:Destroy()
            SG = nil 
        end 
    end
end)

local blatantV2CompleteDelayInput = blatantSection2:AddInput("blatantV2_completeDelay", {
    Title = "Complete Delay",
    Default = tostring(FD),
    Placeholder = tostring(FD)
})
blatantV2CompleteDelayInput:OnChanged(function(v)
    local n = tonumber(v)
    if n and n >= 0 then 
        FD = n 
    end
end)

local blatantV2CancelDelayInput = blatantSection2:AddInput("blatantV2_cancelDelay", {
    Title = "Cancel Delay",
    Default = tostring(KD),
    Placeholder = tostring(KD)
})
blatantV2CancelDelayInput:OnChanged(function(v)
    local n = tonumber(v)
    if n and n >= 0 then 
        KD = n 
    end
end)

-- Variabel untuk menyimpan thread
local ultraFishingThread = nil
local ultraActive = false
local ultraCastCount = 0
local ultraStartTime = 0

-- Remote Functions
local netFolder = nil
local RF_ChargeFishingRod = nil
local RF_RequestMinigame = nil
local RF_CancelFishingInputs = nil
local RF_UpdateAutoFishingState = nil
local RE_FishingCompleted = nil
local RE_MinigameChanged = nil

-- Fungsi untuk mendapatkan remote functions dengan aman
local function getRemotes()
    if not netFolder then
        pcall(function()
            local ReplicatedStorage = game:GetService("ReplicatedStorage")
            netFolder = ReplicatedStorage
                :WaitForChild("Packages")
                :WaitForChild("_Index")
                :WaitForChild("sleitnick_net@0.2.0")
                :WaitForChild("net")
            
            RF_ChargeFishingRod = netFolder:WaitForChild("RF/ChargeFishingRod")
            RF_RequestMinigame = netFolder:WaitForChild("RF/RequestFishingMinigameStarted")
            RF_CancelFishingInputs = netFolder:WaitForChild("RF/CancelFishingInputs")
            RF_UpdateAutoFishingState = netFolder:WaitForChild("RF/UpdateAutoFishingState")
            RE_FishingCompleted = netFolder:WaitForChild("RE/FishingCompleted")
            RE_MinigameChanged = netFolder:WaitForChild("RE/FishingMinigameChanged")
        end)
    end
end

-- Fungsi untuk menjalankan loop ultra
local function ultraSpamLoop()
    while ultraActive do
        local currentTime = tick()
        
        -- Cast fishing rod
        pcall(function()
            RF_ChargeFishingRod:InvokeServer({[1] = currentTime})
        end)
        
        -- Request minigame
        pcall(function()
            RF_RequestMinigame:InvokeServer(1, 0, currentTime)
        end)
        
        ultraCastCount = ultraCastCount + 1
        
        -- Tunggu complete delay
        task.wait(FD or 0.001)
        
        -- Complete fishing
        pcall(function()
            RE_FishingCompleted:FireServer()
        end)
        
        -- Tunggu cancel delay
        task.wait(KD or 0.001)
        
        -- Cancel fishing
        pcall(function()
            RF_CancelFishingInputs:InvokeServer()
        end)
    end
end

-- Handle minigame changed event
local function setupEvents()
    getRemotes()
    
    if RE_MinigameChanged then
        RE_MinigameChanged.OnClientEvent:Connect(function(state)
            if not ultraActive then 
                return 
            end
            
            task.spawn(function()
                task.wait(FD or 0.001)
                
                pcall(function()
                    RE_FishingCompleted:FireServer()
                end)
                
                task.wait(KD or 0.001)
                
                pcall(function()
                    RF_CancelFishingInputs:InvokeServer()
                end)
            end)
        end)
    end
end

-- Setup events saat pertama kali
task.spawn(setupEvents)

local blatantV2Toggle = blatantSection2:AddToggle("blatantV2_toggle", {
    Title = "Enable Blatant V2", 
    Default = false
})

blatantV2Toggle:OnChanged(function(s)
    active = s
    
    if s then
        -- Start Blatant V2 mode
        casts = 0
        start = tick()
        ultraActive = true
        ultraCastCount = 0
        ultraStartTime = tick()
        
        -- Setup state
        pcall(function()
            LocalPlayer:SetAttribute("InCutscene", true)
        end)
        
        safe(function()
            RFU:InvokeServer(true)
        end)
        
        -- Mulai thread lama (jika masih ada) dan thread ultra
        if fishingThread then 
            task.cancel(fishingThread) 
            fishingThread = nil 
        end
        
        if equipThread then 
            task.cancel(equipThread) 
            equipThread = nil 
        end
        
        -- Setup remote functions untuk ultra mode
        getRemotes()
        
        -- Update auto fishing state untuk ultra mode
        pcall(function()
            RF_UpdateAutoFishingState:InvokeServer(false)
        end)
        
        -- Mulai loop ultra
        if ultraFishingThread then
            task.cancel(ultraFishingThread)
        end
        ultraFishingThread = task.spawn(ultraSpamLoop)
        
        -- Juga mulai thread lama (optional, jika masih diperlukan)
        fishingThread = task.spawn(fishingLoop)
        equipThread = task.spawn(equipLoop)
        
    else
        -- Stop semua mode
        ultraActive = false
        
        if ultraFishingThread then 
            task.cancel(ultraFishingThread)
            ultraFishingThread = nil 
        end
        
        if fishingThread then 
            task.cancel(fishingThread)
            fishingThread = nil 
        end 
        
        if equipThread then 
            task.cancel(equipThread)
            equipThread = nil 
        end
        
        -- Reset state
        safe(function()
            RFU:InvokeServer(false)
        end)
        
        safe(function()
            Unequip:FireServer()
        end)
        
        task.wait(.2)
        
        safe(function()
            RFK:InvokeServer()
        end)
        
        -- Update auto fishing state kembali ke normal
        pcall(function()
            if RF_UpdateAutoFishingState then
                RF_UpdateAutoFishingState:InvokeServer(true)
            end
        end)
        
        task.wait(0.2)
        
        -- Cancel fishing inputs terakhir
        pcall(function()
            if RF_CancelFishingInputs then
                RF_CancelFishingInputs:InvokeServer()
            end
        end)
    end
end)
